<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会议日程管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #e0e0e0;
            background-color: #2d3436;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            width: 100vw;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            min-height: 100vh;
            background-color: #34495e;
            padding: 20px;
            border: 1px solid #2c3e50;
            box-sizing: border-box;
        }
        
        h1 {
            text-align: center;
            color: #ecf0f1;
            margin-bottom: 30px;
            font-weight: 300;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .header-controls input {
            padding: 12px 15px;
            border: 1px solid #4a6741;
            border-radius: 6px;
            font-size: 16px;
            width: 200px;
            background-color: #2c3e50;
            color: #ecf0f1;
            transition: all 0.3s ease;
        }
        
        .header-controls input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .header-controls button,
        .action-btn,
        .export-btn,
        .history-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .header-controls button:hover,
        .action-btn:hover,
        .export-btn:hover,
        .history-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .header-controls button:active,
        .action-btn:active,
        .export-btn:active,
        .history-btn:active {
            transform: translateY(0);
        }
        
        /* 主按钮样式 */
        .header-controls button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .header-controls button:hover {
            background: linear-gradient(135deg, #2980b9, #1f6da3);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #2a373f;
            border-radius: 8px;
            overflow: hidden;
            table-layout: fixed;
        }
        
        /* 调整各列宽度和对齐方式 */
        th:nth-child(1), td:nth-child(1) { /* 开始时间 */
            width: 120px;
            padding-left: 20px !important;
        }
        
        th:nth-child(2), td:nth-child(2) { /* 持续时间 */
            width: 100px;
            text-align: left;
            padding-left: 0 !important;
        }
        
        th:nth-child(3), td:nth-child(3) { /* 会议标题 */
            width: 40%;
            text-align: left;
            padding-left: 0 !important;
        }
        
        th:nth-child(4), td:nth-child(4) { /* 讲课人员 */
            width: 250px;
            text-align: center;
            padding-right: 0 !important;
            padding-left: 0 !important;
        }
        
        th:nth-child(5), td:nth-child(5) { /* 操作 */
            width: 100px;
            text-align: right;
            padding-right: 30px !important;
            padding-left: 0 !important;
        }
        
        th {
            padding: 0;
            text-align: left;
            border-bottom: 1px solid #34495e;
            box-sizing: border-box;
            border-right: 1px solid transparent;
            border-left: 1px solid transparent;
            height: 50px;
            line-height: 50px;
        }
        
        td {
            padding: 0;
            text-align: left;
            border-bottom: 1px solid #34495e;
            box-sizing: border-box;
            border-right: 1px solid transparent;
            border-left: 1px solid transparent;
            height: 50px;
            display: table-cell;
            vertical-align: middle;
        }
        
        /* 确保所有输入框与单元格边缘对齐 */
        .input-cell {
            box-sizing: border-box;
            border: 1px solid #4a6741;
            outline: none;
            transition: all 0.3s ease;
            width: 100%;
            height: 100%;
            display: block;
            padding: 8px;
        }
        
        /* 统一表格单元格的高度 */
        tr {
            height: 50px;
        }
        
        th {
            background-color: #1e2a33;
            font-weight: 600;
            color: #ecf0f1;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background-color: #304254;
        }
        
        .input-cell {
            width: 100%;
            height: 40px;
            padding: 0 8px;
            border: 1px solid #4a6741;
            border-radius: 4px;
            font-size: 14px;
            background-color: #1a252f;
            color: #ecf0f1;
            transition: all 0.3s ease;
            line-height: 40px;
            vertical-align: middle;
            display: inline-block;
            box-sizing: border-box;
        }
        
        .input-cell:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .duration-cell {
            width: 120px;
        }
        
        .title-cell {
            width: 100%;
            padding-left: 10px !important;
        }
        
        /* 为讲课人员列的输入框添加右对齐样式 */
        .speaker-cell {
            text-align: right;
            padding-right: 20px !important;
        }
        
        .speaker-cell {
            width: 200px;
        }
        
        .actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            height: 50px;
            padding: 10px 30px 10px 0;
            box-sizing: border-box;
            width: 100%;
            margin-left: auto;
        }
        
        .action-btn {
            padding: 0;
            font-size: 20px;
            font-weight: bold;
            border-radius: 4px;
            width: 40px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .add-btn {
            background-color: #27ae60;
            color: white;
        }
        
        .add-btn:hover {
            background-color: #229954;
        }
        
        .remove-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .remove-btn:hover {
            background-color: #c0392b;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        
        .save-btn:hover {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
        }
        
        .autocomplete {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid #4a6741;
            border-radius: 4px;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #1a252f;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #34495e;
            color: #ecf0f1;
        }
        
        .autocomplete-items div:hover {
            background-color: #34495e;
        }
        
        .time-cell {
            font-weight: 600;
            color: #f39c12;
            font-size: 15px;
        }
        
        .export-controls {
            margin-top: 30px;
            text-align: center;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #16a085, #149174);
            color: white;
            margin: 0 10px;
        }
        
        .export-btn:hover {
            background: linear-gradient(135deg, #149174, #117a65);
        }
        
        .history-controls {
            margin-top: 20px;
            text-align: center;
        }
        
        .history-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            margin: 0 10px;
        }
        
        .history-btn:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
        }
        
        .empty-message {
            text-align: center;
            color: #95a5a6;
            padding: 40px;
            font-style: italic;
        }
        
        /* 添加滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #2c3e50;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }
        
        @media print {
            body {
                background-color: white;
                color: black;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            
            .header-controls,
            .actions,
            .export-controls {
                display: none;
            }
            
            .container {
                box-shadow: none;
                width: 100%;
                padding: 0;
                background-color: white;
            }
            
            table {
                page-break-inside: avoid;
                background-color: #2a373f;
                color: black;
            }
            
            th {
                background-color: #1e2a33;
                color: white;
            }
            tr {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>会议日程管理</h1>
        
        <div class="header-controls">
            <input type="number" id="meetingStartTime" placeholder="输入会议开始时间（如：8）" min="0" max="23">
            <button id="initSchedule">修改起始时间</button>
            <button id="clearAll" class="remove-btn">清空所有</button>
        </div>
        
        <table id="scheduleTable">
            <thead>
                <tr>
                    <th>时间</th>
                    <th>持续时间(分钟)</th>
                    <th>会议标题</th>
                    <th>讲课人员</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="scheduleBody">
                <tr class="empty-message">
                    <td colspan="5">请先输入会议开始时间并点击初始化日程</td>
                </tr>
            </tbody>
        </table>
        
        <div class="export-controls">
        <button id="copyTabSeparated" class="export-btn">复制Tab分隔内容</button>
        <button id="printSchedule" class="export-btn">打印</button>
    </div>
    
    <div class="history-controls">
        <button id="saveSchedule" class="history-btn">保存当前日程</button>
        <button id="loadHistory" class="history-btn">读取往日会议</button>
    </div>
    </div>

    <script>
        // 添加页面刷新提示
        window.addEventListener('beforeunload', function(e) {
            // 检查是否有内容可以保存
            const scheduleBody = document.getElementById('scheduleBody');
            if (scheduleBody && scheduleBody.children.length > 0 && 
                !(scheduleBody.children.length === 1 && scheduleBody.children[0].classList.contains('empty-message'))) {
                // 标准提示消息
                const message = '确定要离开吗？未保存的内容将会丢失。';
                
                // 兼容不同浏览器
                e.returnValue = message;
                return message;
            }
        });
        
        // 获取localStorage中保存的讲课人员数据
        let speakers = JSON.parse(localStorage.getItem('meetingSpeakers') || '[]');
        let currentStartTime = null;
        
        // 修改起始时间函数
        function modifyStartTime() {
            const startTimeInput = document.getElementById('meetingStartTime').value;
            if (!startTimeInput) {
                alert('请输入会议开始时间');
                return;
            }
            
            const startHour = parseInt(startTimeInput);
            if (isNaN(startHour) || startHour < 0 || startHour > 23) {
                alert('请输入有效的小时数 (0-23)');
                return;
            }
            
            // 设置当前开始时间为会议开始时间
            currentStartTime = { hour: startHour, minute: 0 };
            
            const scheduleBody = document.getElementById('scheduleBody');
            
            // 如果表格为空，则添加第一行
            if (scheduleBody.children.length === 0 || (scheduleBody.children.length === 1 && scheduleBody.children[0].classList.contains('empty-message'))) {
                scheduleBody.innerHTML = '';
                addNewRow();
            } else {
                // 否则重新计算所有行的时间
                recalculateTimes();
            }
        }
        
        // 修改起始时间按钮事件
        document.getElementById('initSchedule').addEventListener('click', modifyStartTime);
        
        // 为会议开始时间输入框添加回车事件
        document.getElementById('meetingStartTime').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                modifyStartTime();
            }
        });

        
        // 清空所有
        document.getElementById('clearAll').addEventListener('click', function() {
            if (confirm('确定要清空所有日程吗？')) {
                document.getElementById('scheduleBody').innerHTML = `
                    <tr class="empty-message">
                        <td colspan="5">请先输入会议开始时间并点击初始化日程</td>
                    </tr>
                `;
                currentStartTime = null;
            }
        });
        
        // 添加新行
        function addNewRow() {
            const scheduleBody = document.getElementById('scheduleBody');
            
            const tr = document.createElement('tr');
            
            // 格式化当前时间
            const formattedStartTime = formatTime(currentStartTime);
            
            tr.innerHTML = `
                <td class="time-cell">${formattedStartTime}</td>
                <td>
                    <input type="number" class="input-cell duration-cell" placeholder="持续分钟数" value="30">
                </td>
                <td class="title-cell">
                    <input type="text" class="input-cell title-input" placeholder="输入会议标题">
                </td>
                <td class="speaker-cell">
                    <div class="autocomplete">
                        <input type="text" class="input-cell speaker-input" placeholder="输入讲课人员">
                        <div class="autocomplete-items"></div>
                    </div>
                </td>
                <td class="actions">
                    <button class="action-btn add-btn" title="添加下一项">+</button>
                    <button class="action-btn remove-btn" title="删除">-</button>
                </td>
            `;
            
            scheduleBody.appendChild(tr);
            
            // 添加持续时间输入事件和失焦事件
            const durationInput = tr.querySelector('.duration-cell');
            durationInput.addEventListener('input', function() {
                updateEndTime(tr);
            });
            
            // 新行创建后立即计算时间，确保显示完整时间段
            updateEndTime(tr);
            
            // 添加失焦事件，当鼠标焦点移开时重新计算所有行的时间
            durationInput.addEventListener('blur', function() {
                // 先更新当前行的结束时间
                updateEndTime(tr);
                // 然后从第一行开始重新计算所有行的时间
                recalculateTimes();
            });
            
            // 添加添加下一项按钮事件
            const addBtn = tr.querySelector('.add-btn');
            addBtn.addEventListener('click', function() {
                // 先更新当前行的结束时间
                updateEndTime(tr);
                // 然后添加新行
                addNewRow();
            });
            
            // 添加删除按钮事件
            const removeBtn = tr.querySelector('.remove-btn');
            removeBtn.addEventListener('click', function() {
                // 如果只有一行，不允许删除
                if (scheduleBody.children.length <= 1) {
                    alert('至少保留一行日程');
                    return;
                }
                tr.remove();
                // 重新计算后续行的时间
                recalculateTimes();
            });
            
            // 设置讲课人员自动补全
            const speakerInput = tr.querySelector('.speaker-input');
            setupAutocomplete(speakerInput);
            
            // 保存讲课人员到localStorage
            speakerInput.addEventListener('blur', function() {
                const speakerName = this.value.trim();
                if (speakerName && !speakers.includes(speakerName)) {
                    speakers.push(speakerName);
                    localStorage.setItem('meetingSpeakers', JSON.stringify(speakers));
                }
            });
            
            // 为所有输入框添加回车键事件监听，按下回车添加下一行
            function setupEnterKeyEvent(inputElement, saveCallback = null) {
                inputElement.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); // 阻止表单提交
                        // 先更新当前行的结束时间
                        updateEndTime(tr);
                        // 然后添加新行
                        addNewRow();
                        // 执行保存回调（如果有）
                        if (saveCallback) {
                            saveCallback();
                        }
                    }
                });
            }
            
            // 为会议标题输入框添加回车事件
            const titleInput = tr.querySelector('.title-input');
            setupEnterKeyEvent(titleInput);
            
            // 为讲课人员输入框添加回车事件
            setupEnterKeyEvent(speakerInput, function() {
                const speakerName = speakerInput.value.trim();
                if (speakerName && !speakers.includes(speakerName)) {
                    speakers.push(speakerName);
                    localStorage.setItem('meetingSpeakers', JSON.stringify(speakers));
                }
            });
        }
        
        // 更新结束时间
        function updateEndTime(row) {
            const durationInput = row.querySelector('.duration-cell');
            const duration = parseInt(durationInput.value);
            
            if (!isNaN(duration) && duration > 0) {
                // 从时间单元格中获取该行的开始时间
                const timeCell = row.querySelector('.time-cell');
                const timeText = timeCell.textContent;
                const startTimeStr = timeText.includes('-') ? timeText.split('-')[0].trim() : timeText.trim();
                const startTime = parseTime(startTimeStr);
                
                // 计算结束时间
                const endTime = addMinutesToTime(startTime, duration);
                
                // 更新时间显示
                timeCell.textContent = `${formatTime(startTime)} - ${formatTime(endTime)}`;
                
                // 重新计算后续行的时间
                recalculateTimes(row.nextElementSibling);
            }
        }
        
        // 重新计算时间
        function recalculateTimes(startRow = null) {
            const rows = Array.from(document.getElementById('scheduleBody').children);
            let calcStartTime = null;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // 如果是第一行且有currentStartTime，强制使用currentStartTime作为开始时间，并确保从整点开始
                if (i === 0 && currentStartTime) {
                    calcStartTime = { hour: currentStartTime.hour, minute: 0 };
                } 
                // 如果是起始行或还没有设置计算开始时间，则从这一行开始计算
                else if (row === startRow || calcStartTime === null) {
                    // 从时间单元格中提取开始时间
                    const timeCell = row.querySelector('.time-cell');
                    const timeText = timeCell.textContent;
                    const startTimeStr = timeText.includes('-') ? timeText.split('-')[0].trim() : timeText.trim();
                    
                    calcStartTime = parseTime(startTimeStr);
                }
                
                // 更新时间显示
                const timeCell = row.querySelector('.time-cell');
                const durationInput = row.querySelector('.duration-cell');
                const duration = parseInt(durationInput.value) || 30; // 默认30分钟
                
                // 保存原始开始时间（不修改）
                const originalStartTime = { ...calcStartTime };
                
                if (!isNaN(duration) && duration > 0) {
                    const endTime = addMinutesToTime(calcStartTime, duration);
                    timeCell.textContent = `${formatTime(originalStartTime)} - ${formatTime(endTime)}`;
                    calcStartTime = endTime;
                } else {
                    timeCell.textContent = formatTime(originalStartTime);
                }
            }
            
            // 不再更新currentStartTime，保持用户设置的起始时间不变
        }
        
        // 格式化时间
        function formatTime(timeObj) {
            return `${String(timeObj.hour).padStart(2, '0')}:${String(timeObj.minute).padStart(2, '0')}`;
        }
        
        // 解析时间字符串
        function parseTime(timeStr) {
            const [hour, minute] = timeStr.split(':').map(Number);
            return { hour, minute };
        }
        
        // 添加分钟到时间
        function addMinutesToTime(timeObj, minutes) {
            let newHour = timeObj.hour;
            let newMinute = timeObj.minute + minutes;
            
            // 处理分钟进位
            while (newMinute >= 60) {
                newMinute -= 60;
                newHour += 1;
            }
            
            // 处理小时进位（24小时制）
            newHour = newHour % 24;
            
            return { hour: newHour, minute: newMinute };
        }
        
        // 设置自动补全
        function setupAutocomplete(inputElement) {
            const autocompleteContainer = inputElement.parentElement;
            const suggestionsContainer = autocompleteContainer.querySelector('.autocomplete-items');
            
            inputElement.addEventListener('input', function() {
                const value = this.value.trim().toLowerCase();
                suggestionsContainer.innerHTML = '';
                
                if (value.length < 1) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                
                // 筛选匹配的讲课人员
                const matches = speakers.filter(speaker => 
                    speaker.toLowerCase().includes(value)
                );
                
                if (matches.length > 0) {
                    suggestionsContainer.style.display = 'block';
                    
                    // 添加匹配项
                    matches.forEach(match => {
                        const div = document.createElement('div');
                        div.textContent = match;
                        div.addEventListener('click', function() {
                            inputElement.value = match;
                            suggestionsContainer.style.display = 'none';
                        });
                        suggestionsContainer.appendChild(div);
                    });
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            });
            
            // 点击外部关闭自动补全
            document.addEventListener('click', function(e) {
                if (!autocompleteContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }
        
        // 复制Tab分隔内容
        document.getElementById('copyTabSeparated').addEventListener('click', function() {
            const rows = Array.from(document.getElementById('scheduleBody').children);
            
            // 生成表头（可选）
            let tabContent = `时间\t持续时间(分钟)\t会议标题\t讲课人员\n`;
            
            // 生成数据行，使用Tab分隔
            rows.forEach(row => {
                // 跳过空消息行
                if (row.classList.contains('empty-message')) {
                    return;
                }
                
                const timeCell = row.querySelector('.time-cell');
                const durationInput = row.querySelector('.duration-cell');
                const titleInput = row.querySelector('.title-input');
                const speakerInput = row.querySelector('.speaker-input');
                
                const time = timeCell.textContent || '';
                const duration = durationInput.value || '';
                const title = titleInput.value || '';
                const speaker = speakerInput.value || '';
                
                // 添加Tab分隔的数据行
                tabContent += `${time}\t${duration}\t${title}\t${speaker}\n`;
            });
            
            // 复制到剪贴板
            navigator.clipboard.writeText(tabContent)
                .then(() => {
                    alert('内容已复制到剪贴板，现在可以粘贴到Excel中');
                })
                .catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败，请手动复制');
                });
        });
        
        // 打印日程
        document.getElementById('printSchedule').addEventListener('click', function() {
            window.print();
        });
        
        // 生成时间戳（年月日时分格式）
        function generateTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            return `${year}${month}${day}${hour}${minute}`;
        }
        
        // 格式化时间戳为可读日期时间
        function formatTimestamp(timestamp) {
            if (timestamp.length !== 12) return timestamp;
            
            const year = timestamp.substring(0, 4);
            const month = timestamp.substring(4, 6);
            const day = timestamp.substring(6, 8);
            const hour = timestamp.substring(8, 10);
            const minute = timestamp.substring(10, 12);
            
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }
        
        // 保存当前日程为本地JSON文件
        document.getElementById('saveSchedule').addEventListener('click', function() {
            const rows = Array.from(document.getElementById('scheduleBody').children);
            const scheduleData = [];
            
            // 收集所有日程行数据
            rows.forEach(row => {
                // 跳过空消息行
                if (row.classList.contains('empty-message')) {
                    return;
                }
                
                const timeCell = row.querySelector('.time-cell');
                const durationInput = row.querySelector('.duration-cell');
                const titleInput = row.querySelector('.title-cell');
                const speakerInput = row.querySelector('.speaker-cell');
                
                // 确保获取到所有元素
                if (timeCell && durationInput && titleInput && speakerInput) {
                    scheduleData.push({
                        time: timeCell.textContent || '',
                        duration: durationInput.value || '',
                        title: titleInput.value || '',
                        speaker: speakerInput.value || ''
                    });
                }
            });
            
            // 如果没有有效的日程数据，不保存
            if (scheduleData.length === 0) {
                alert('没有可保存的日程数据');
                return;
            }
            
            // 生成时间戳作为文件名
            const timestamp = generateTimestamp();
            
            // 创建完整的日程数据对象，包含创建时间和开始时间设置
            const fullData = {
                timestamp: timestamp,
                createdAt: new Date().toISOString(),
                startTime: currentStartTime,
                schedule: scheduleData
            };
            
            // 将数据转换为JSON字符串
            const jsonStr = JSON.stringify(fullData, null, 2);
            
            // 创建Blob对象
            const blob = new Blob([jsonStr], { type: 'application/json' });
            
            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // 在文件名前添加文件夹标识，方便用户识别
            a.download = `会议日程_${timestamp}.json`;
            document.body.appendChild(a);
            
            // 触发下载
            a.click();
            
            // 清理
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // 添加提示信息，提醒用户保存到指定文件夹
            alert(`日程已准备下载。\n\n请在弹出的保存对话框中选择或创建"会议日程"文件夹作为保存位置。\n\n建议文件名: 会议日程_${timestamp}.json`);
        });
        
        // 添加文件选择输入元素（隐藏）
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
        
        // 查看往日会议 - 打开文件选择器
        document.getElementById('loadHistory').addEventListener('click', function() {
            fileInput.click();
        });
        
        // 处理文件选择事件
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 检查文件扩展名
            if (!file.name.endsWith('.json')) {
                alert('请选择JSON格式的文件');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    // 解析JSON文件
                    const fileContent = event.target.result;
                    const data = JSON.parse(fileContent);
                    
                    // 详细验证数据格式
                    let validationErrors = [];
                    
                    if (!data) {
                        validationErrors.push('文件内容为空或不是有效的JSON对象');
                    }
                    
                    if (!data.schedule) {
                        validationErrors.push('缺少必要的schedule字段');
                    } else if (!Array.isArray(data.schedule)) {
                        validationErrors.push('schedule字段必须是数组格式');
                    } else if (data.schedule.length === 0) {
                        validationErrors.push('schedule数组不能为空');
                    } else {
                        // 验证数组中的每个元素
                        for (let i = 0; i < data.schedule.length; i++) {
                            const item = data.schedule[i];
                            if (typeof item !== 'object') {
                                validationErrors.push(`schedule数组第${i+1}项必须是对象格式`);
                                break;
                            }
                        }
                    }
                    
                    if (validationErrors.length > 0) {
                        alert('JSON文件格式验证失败:\n' + validationErrors.join('\n'));
                        return;
                    }
                    
                    // 加载日程数据
                    loadScheduleFromHistory(data);
                } catch (error) {
                    // 提供更详细的错误信息
                    let errorMessage = '文件解析失败，请检查JSON格式';
                    
                    if (error instanceof SyntaxError) {
                        errorMessage += '\n\n语法错误: ' + error.message;
                        
                        // 尝试获取错误位置附近的文本
                        if (error.lineNumber && error.columnNumber) {
                            errorMessage += `\n错误位置: 第${error.lineNumber}行，第${error.columnNumber}列`;
                        }
                    } else {
                        errorMessage += '\n\n' + error.message;
                    }
                    
                    alert(errorMessage);
                    console.error('文件解析错误:', error);
                }
            };
            
            reader.onerror = function() {
                alert('文件读取失败');
            };
            
            // 读取文件内容
            reader.readAsText(file);
            
            // 重置文件输入，允许重复选择同一个文件
            fileInput.value = '';
        });
        
        // 从历史记录加载日程
        function loadScheduleFromHistory(data) {
            try {
                // 清空当前日程表
                const scheduleBody = document.getElementById('scheduleBody');
                if (!scheduleBody) {
                    alert('无法找到日程表容器');
                    return;
                }
                scheduleBody.innerHTML = '';
                
                // 恢复开始时间设置
                const startTimeInput = document.getElementById('startTimeInput');
                if (startTimeInput) {
                    if (data.startTime && typeof data.startTime === 'object' && data.startTime.hour !== undefined) {
                        currentStartTime = data.startTime;
                        startTimeInput.value = data.startTime.hour;
                    } else {
                        // 如果没有开始时间，使用默认值
                        currentStartTime = { hour: 8, minute: 0 };
                        startTimeInput.value = 8;
                    }
                } else {
                    console.warn('无法找到开始时间输入框');
                    currentStartTime = { hour: 8, minute: 0 };
                }
                
                // 恢复日程行
                if (data.schedule && Array.isArray(data.schedule) && data.schedule.length > 0) {
                    let validRowsCount = 0;
                    
                    data.schedule.forEach((item, index) => {
                        if (typeof item === 'object' && item !== null) {
                            try {
                                addNewRow();
                                const newRow = scheduleBody.lastElementChild;
                                
                                if (newRow) {
                                    const timeCell = newRow.querySelector('.time-cell');
                                    const durationInput = newRow.querySelector('.duration-cell');
                                    const titleInput = newRow.querySelector('.title-input');
                                    const speakerInput = newRow.querySelector('.speaker-input');
                                    
                                    // 安全地设置值，确保每个元素都存在
                                    if (timeCell) timeCell.textContent = String(item.time || '');
                                    if (durationInput) durationInput.value = String(item.duration || '');
                                    if (titleInput) titleInput.value = String(item.title || '');
                                    if (speakerInput) speakerInput.value = String(item.speaker || '');
                                    
                                    // 确保为加载的行设置自动补全
                                    if (speakerInput) {
                                        setupAutocomplete(speakerInput);
                                    }
                                    
                                    validRowsCount++;
                                }
                            } catch (rowError) {
                                console.warn(`处理第${index+1}行数据时出错:`, rowError);
                            }
                        }
                    });
                    
                    // 重新计算时间确保连续性
                    if (validRowsCount > 0) {
                        try {
                            recalculateTimes();
                        } catch (calcError) {
                            console.warn('重新计算时间时出错:', calcError);
                        }
                    }
                    
                    alert(`已加载 ${validRowsCount} 条会议记录${data.timestamp ? ' (' + formatTimestamp(data.timestamp) + ')' : ''}`);
                } else {
                    // 如果没有有效数据，显示提示
                    const emptyRow = document.createElement('tr');
                    emptyRow.className = 'empty-message';
                    emptyRow.innerHTML = '<td colspan="4" style="text-align:center; color: #999;">暂无会议记录</td>';
                    scheduleBody.appendChild(emptyRow);
                    alert('文件中没有找到有效会议记录');
                }
            } catch (error) {
                console.error('加载日程数据时出错:', error);
                alert('加载日程失败: ' + error.message);
            }
        }
    </script>
</body>
</html>
